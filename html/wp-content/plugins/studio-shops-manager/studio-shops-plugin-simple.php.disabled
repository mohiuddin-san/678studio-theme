<?php
/*
Plugin Name: Studio Shops Manager (Simple Gallery) - SIMPLE VERSION
Description: Simplified Studio Shops management with simple gallery upload
Version: 2.0.0
Author: Your Name
*/

defined('ABSPATH') or die('No direct access allowed.');

// Include API helper
require_once plugin_dir_path(__FILE__) . 'includes/api-helper.php';

// AJAX handler for internal API calls
add_action('wp_ajax_studio_shop_internal_api', 'handle_studio_shop_internal_api');
add_action('wp_ajax_nopriv_studio_shop_internal_api', 'handle_studio_shop_internal_api');

function handle_studio_shop_internal_api() {
    // Check if data comes from FormData (POST) or JSON
    if (isset($_POST['endpoint'])) {
        // FormData submission - build data array from POST parameters
        $endpoint = $_POST['endpoint'];
        $data = array();
        
        // Extract all POST parameters except 'action' and 'endpoint'
        foreach ($_POST as $key => $value) {
            if ($key !== 'action' && $key !== 'endpoint') {
                $data[$key] = $value;
            }
        }
        
        // Handle special case where data is JSON encoded
        if (isset($_POST['data'])) {
            $json_data = json_decode(stripslashes($_POST['data']), true);
            if ($json_data) {
                $data = array_merge($data, $json_data);
            }
        }
        
    } else {
        // JSON submission (fallback)
        $input = json_decode(file_get_contents('php://input'), true);
        
        if (!$input || !isset($input['endpoint']) || !isset($input['data'])) {
            wp_die(json_encode(['success' => false, 'error' => 'Invalid request data']));
        }
        
        $endpoint = $input['endpoint'];
        $data = $input['data'];
    }
    
    $result = make_internal_api_call($endpoint, $data);
    
    wp_die(json_encode($result));
}

// Add admin menu for Studio Shops
add_action('admin_menu', 'studio_shops_menu');
function studio_shops_menu() {
    add_menu_page(
        'Studio Shops', 
        'Studio Shops',
        'manage_options',
        'studio-shops',
        'studio_shops_page',
        'dashicons-camera-alt',
        6
    );
}

function studio_shops_page() {
    // Clear cache if requested
    if (isset($_GET['clear_studio_cache']) && current_user_can('administrator')) {
        // Clear unified cache system
        if (function_exists('clear_studio_data_cache')) {
            clear_studio_data_cache();
            echo '<div class="notice notice-success"><p>スタジオデータキャッシュをクリアしました。</p></div>';
        }
    }
    
    ?>
    <div class="wrap">
        <h1>🏢 Studio Shops Management (Simple Gallery)</h1>
        <p>店舗情報とシンプルなギャラリー画像を管理します。</p>
        
        <form method="post" enctype="multipart/form-data">
            <?php wp_nonce_field('studio_shops_save', 'studio_shops_nonce'); ?>
            
            <!-- キャッシュクリアボタン -->
            <div style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #0073aa;">
                <p><strong>キャッシュ管理:</strong> ショップ情報がフロントエンドに反映されない場合は、キャッシュをクリアしてください。</p>
                <a href="?page=studio-shops&clear_studio_cache=1" class="button button-secondary">🗑️ スタジオデータキャッシュをクリア</a>
            </div>
            
            <div>
                <label><input type="checkbox" id="update-mode" name="update_mode"> Update Existing Shop</label>
                <div id="shop-selector" style="display:none; margin-top:10px;">
                    <select name="shop_id" id="shop-id-select">
                        <option value="">Select a Shop</option>
                    </select>
                    <button type="button" id="delete-shop-btn" style="margin-left: 15px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;"
                            onmouseover="this.style.background='#555'" 
                            onmouseout="this.style.background='#666'">
                        🗑️ このショップを削除
                    </button>
                </div>
            </div>

            <?php
            // Check if form is submitted
            $is_update_mode = isset($_POST['update_mode']) && $_POST['update_mode'] === 'on';
            
            if (isset($_POST['submit_shop']) && check_admin_referer('studio_shops_save', 'studio_shops_nonce')) {
                $name = sanitize_text_field($_POST['name']);
                $address = sanitize_textarea_field($_POST['address']);
                $phone = sanitize_text_field($_POST['phone']);
                $nearest_station = sanitize_text_field($_POST['nearest_station']);
                $business_hours = sanitize_text_field($_POST['business_hours']);
                $holidays = sanitize_text_field($_POST['holidays']);
                $map_url = wp_kses($_POST['map_url'], [
                    'iframe' => [
                        'src' => [],
                        'width' => [],
                        'height' => [],
                        'style' => [],
                        'frameborder' => [],
                        'allowfullscreen' => [],
                        'loading' => []
                    ]
                ]);
                $company_email = sanitize_email($_POST['company_email']);
                $shop_id = isset($_POST['shop_id']) ? sanitize_text_field($_POST['shop_id']) : '';

                // Validate shop_id for update mode
                if ($is_update_mode && empty($shop_id)) {
                    echo '<div class="error"><p>' . esc_html__('Error: Shop ID is missing during update.', 'studio-shops') . '</p></div>';
                } else {
                    // Handle main image
                    $main_image = null;
                    if (isset($_FILES['main_image']) && $_FILES['main_image']['error'] === UPLOAD_ERR_OK) {
                        $tmp_name = $_FILES['main_image']['tmp_name'];
                        if (file_exists($tmp_name)) {
                            $image_data = file_get_contents($tmp_name);
                            $image_type = $_FILES['main_image']['type'];
                            $main_image = 'data:' . $image_type . ';base64,' . base64_encode($image_data);
                        }
                    }
                    
                    // Handle main gallery images
                    $main_gallery_images = [];
                    
                    if (!empty($_FILES['gallery_images_flat'])) {
                        $gallery_flat_files = $_FILES['gallery_images_flat'];
                        
                        // Check if it's a single file or multiple files
                        if (is_array($gallery_flat_files['name'])) {
                            // Multiple files
                            for ($i = 0; $i < count($gallery_flat_files['name']); $i++) {
                                if ($gallery_flat_files['error'][$i] === UPLOAD_ERR_OK) {
                                    $tmp_name = $gallery_flat_files['tmp_name'][$i];
                                    if (file_exists($tmp_name)) {
                                        $image_data = file_get_contents($tmp_name);
                                        $image_type = $gallery_flat_files['type'][$i];
                                        $base64_image = 'data:' . $image_type . ';base64,' . base64_encode($image_data);
                                        $main_gallery_images[] = $base64_image;
                                    }
                                }
                            }
                        } else {
                            // Single file
                            if ($gallery_flat_files['error'] === UPLOAD_ERR_OK) {
                                $tmp_name = $gallery_flat_files['tmp_name'];
                                if (file_exists($tmp_name)) {
                                    $image_data = file_get_contents($tmp_name);
                                    $image_type = $gallery_flat_files['type'];
                                    $base64_image = 'data:' . $image_type . ';base64,' . base64_encode($image_data);
                                    $main_gallery_images[] = $base64_image;
                                }
                            }
                        }
                    }

                    // Create the API data
                    $api_data = [
                        'name' => $name,
                        'address' => $address,
                        'phone' => $phone,
                        'nearest_station' => $nearest_station,
                        'business_hours' => $business_hours,
                        'holidays' => $holidays,
                        'map_url' => $map_url,
                        'company_email' => $company_email,
                        'gallery_images' => $main_gallery_images
                    ];
                    
                    // Add main image if provided
                    if ($main_image) {
                        $api_data['main_image'] = $main_image;
                    }

                    if ($is_update_mode) {
                        $api_data['shop_id'] = $shop_id;
                    }

                    $api_endpoint = $is_update_mode ? 'update_shop_details.php' : 'studio_shop.php';
                    
                    // Make internal API call
                    $response_body = make_internal_api_call($api_endpoint, $api_data);
                    $response = array('body' => json_encode($response_body));
                    
                    if (is_wp_error($response)) {
                        $error_message = $response->get_error_message();
                        echo '<div class="error"><p>' . esc_html__('API request failed: ' . $error_message, 'studio-shops') . '</p></div>';
                    } else {
                        $response_body = json_decode(wp_remote_retrieve_body($response), true);
                        if (isset($response_body['success']) && $response_body['success']) {
                            $shop_id = $is_update_mode ? $shop_id : ($response_body['shop_id'] ?? '');
                            
                            if ($shop_id) {
                                echo '<div class="updated"><p>' . esc_html__($is_update_mode ? 'Shop updated successfully!' : 'Shop created successfully!', 'studio-shops') . '</p></div>';
                                
                                // Add JavaScript to refresh shop list after successful creation/update
                                if (!$is_update_mode && $shop_id) {
                                    echo '<div class="notice notice-info" style="padding: 15px; background: #e8f4f8; border-left: 4px solid #0073aa; margin: 20px 0;">
                                        <p style="font-size: 16px; margin: 0;">
                                            <strong>✅ 店舗が正常に登録されました！</strong><br>
                                            📸 ギャラリー画像の管理ができるようになりました。
                                        </p>
                                    </div>';
                                    
                                    // Auto-switch to update mode and refresh shop list
                                    echo '<script>
                                        document.addEventListener("DOMContentLoaded", function() {
                                            setTimeout(() => {
                                                const updateModeCheckbox = document.getElementById("update-mode");
                                                const shopSelector = document.getElementById("shop-selector");
                                                const submitBtn = document.getElementById("submit_shop");
                                                
                                                if (updateModeCheckbox) updateModeCheckbox.checked = true;
                                                if (shopSelector) shopSelector.style.display = "block";
                                                if (submitBtn) submitBtn.value = "🔄 ショップを更新";
                                                
                                                // Refresh shop list after a delay to ensure database commit
                                                setTimeout(() => {
                                                    if (typeof loadShopList === "function") {
                                                        loadShopList();
                                                    }
                                                }, 1000);
                                            }, 100);
                                        });
                                    </script>';
                                }
                            } else {
                                echo '<div class="error"><p>' . esc_html__('Operation failed: Shop ID not returned from API.', 'studio-shops') . '</p></div>';
                            }
                        } else {
                            echo '<div class="error"><p>' . esc_html__('Operation failed: ' . ($response_body['error'] ?? 'Unknown error'), 'studio-shops') . '</p></div>';
                        }
                    }
                }
            }
            ?>

            <!-- Basic Information Section -->
            <div style="margin: 30px 0; padding: 25px; border: 2px solid #666; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px; font-weight: 600;">🏢 基本情報</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label for="name" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">店舗名 <span style="color: #d63638;">*</span></label>
                        <input type="text" id="name" name="name" required 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" 
                               placeholder="例: えがお写真館 本店">
                    </div>
                    
                    <div>
                        <label for="phone" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">電話番号</label>
                        <input type="text" id="phone" name="phone" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" 
                               placeholder="例: 03-1234-5678">
                    </div>
                </div>

                <div>
                    <label for="address" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">住所 <span style="color: #d63638;">*</span></label>
                    <textarea id="address" name="address" required rows="3" 
                              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;" 
                              placeholder="例: 〒170-0002 東京都豊島区巣鴨３丁目２０−１４ 山下ビル ２F"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <label for="nearest_station" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">最寄り駅</label>
                        <input type="text" id="nearest_station" name="nearest_station" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" 
                               placeholder="例: 巣鴨駅">
                    </div>
                    
                    <div>
                        <label for="company_email" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">メールアドレス</label>
                        <input type="email" id="company_email" name="company_email" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" 
                               placeholder="例: info@example.com">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <label for="business_hours" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">営業時間</label>
                        <input type="text" id="business_hours" name="business_hours" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" 
                               placeholder="例: 10:00-19:00">
                    </div>
                    
                    <div>
                        <label for="holidays" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">定休日</label>
                        <input type="text" id="holidays" name="holidays" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" 
                               placeholder="例: 不定休">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label for="map_url" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Google Maps埋め込みコード</label>
                    <textarea id="map_url" name="map_url" rows="4" 
                              style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;" 
                              placeholder="Google Mapsの埋め込みiframeコードを貼り付けてください"></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">Google Mapsで「共有」→「地図を埋め込む」からiframeコードをコピーして貼り付けてください</small>
                </div>
            </div>

            <!-- メイン画像セクション -->
            <div style="margin: 30px 0; padding: 25px; border: 2px solid #0073aa; border-radius: 12px; background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);">
                <h3 style="margin: 0 0 20px 0; color: #0073aa; font-size: 20px; font-weight: 600;">🖼️ メイン画像</h3>
                <p style="color: #666; margin-bottom: 20px;">店舗の代表的な画像をアップロードしてください。</p>
                
                <div>
                    <label for="main_image" style="display: block; margin-bottom: 5px; font-weight: 500; color: #0073aa;">メイン画像</label>
                    <input type="file" id="main_image" name="main_image" accept="image/*"
                           style="width: 100%; padding: 10px; border: 2px dashed #0073aa; border-radius: 6px; background: white;">
                    <small style="display: block; margin-top: 5px; color: #666;">JPG、PNG、GIF形式の画像ファイルを選択してください</small>
                </div>
                
                <div id="main-image-preview" style="margin-top: 20px;">
                    <!-- プレビュー画像がここに表示されます -->
                </div>
            </div>

            <!-- Gallery Section -->
            <div style="margin: 30px 0; padding: 25px; border: 2px solid #666; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px; font-weight: 600;">📸 ギャラリー画像</h3>
                <p style="color: #666; margin-bottom: 20px;">店舗のギャラリー画像をアップロードできます。複数の画像を同時に選択可能です。</p>
                
                <div>
                    <label for="gallery_images_flat" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">ギャラリー画像</label>
                    <input type="file" id="gallery_images_flat" name="gallery_images_flat[]" multiple accept="image/*"
                           style="width: 100%; padding: 10px; border: 2px dashed #666; border-radius: 6px; background: white;">
                    <small style="display: block; margin-top: 5px; color: #666;">JPG、PNG、GIF形式の画像ファイルを選択してください（複数選択可能）</small>
                </div>
                
                <div id="gallery-preview" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                    <!-- プレビュー画像がここに表示されます -->
                </div>
            </div>

            <!-- Submit Section -->
            <div style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; text-align: center; border: 2px solid #666;">
                <input type="submit" name="submit_shop" id="submit_shop" 
                       value="<?php echo $is_update_mode ? '🔄 ショップを更新' : '✨ ショップを登録'; ?>"
                       style="background: linear-gradient(135deg, #666 0%, #555 100%); color: white; border: none; padding: 15px 40px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(102, 102, 102, 0.3); transition: all 0.3s ease; text-transform: none;"
                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 102, 102, 0.4)'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(102, 102, 102, 0.3)'"
                       onmousedown="this.style.transform='translateY(0)'"
                       onmouseup="this.style.transform='translateY(-2px)'">
            </div>
        </form>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Gallery image preview
            const galleryInput = document.getElementById('gallery_images_flat');
            const galleryPreview = document.getElementById('gallery-preview');
            
            galleryInput.addEventListener('change', function(e) {
                galleryPreview.innerHTML = '';
                
                for (let i = 0; i < e.target.files.length; i++) {
                    const file = e.target.files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.width = '100px';
                            img.style.height = '100px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '6px';
                            img.style.border = '2px solid #ddd';
                            galleryPreview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });

            // Update mode functionality
            const updateModeCheckbox = document.getElementById('update-mode');
            const shopSelector = document.getElementById('shop-selector');
            const shopSelect = document.getElementById('shop-id-select');
            const deleteShopBtn = document.getElementById('delete-shop-btn');
            const submitBtn = document.getElementById('submit_shop');

            updateModeCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    shopSelector.style.display = 'block';
                    submitBtn.value = '🔄 ショップを更新';
                    loadShopList();
                } else {
                    shopSelector.style.display = 'none';
                    submitBtn.value = '✨ ショップを登録';
                    clearForm();
                }
            });

            function loadShopList() {
                fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'action=studio_shop_internal_api&endpoint=get_all_studio_shop.php'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.shops) {
                        shopSelect.innerHTML = '<option value="">Select a Shop</option>';
                        data.shops.forEach(shop => {
                            const option = document.createElement('option');
                            option.value = shop.id;
                            option.textContent = shop.name;
                            shopSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading shops:', error));
            }

            shopSelect.addEventListener('change', function() {
                if (this.value) {
                    deleteShopBtn.style.display = 'inline-block';
                    loadShopData(this.value);
                } else {
                    deleteShopBtn.style.display = 'none';
                    clearForm();
                }
            });

            function loadShopData(shopId) {
                // Load shop data for editing
                fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=studio_shop_internal_api&endpoint=get_all_studio_shop.php`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.shops) {
                        const shop = data.shops.find(s => s.id == shopId);
                        if (shop) {
                            document.getElementById('name').value = shop.name || '';
                            document.getElementById('address').value = shop.address || '';
                            document.getElementById('phone').value = shop.phone || '';
                            document.getElementById('nearest_station').value = shop.nearest_station || '';
                            document.getElementById('business_hours').value = shop.business_hours || '';
                            document.getElementById('holidays').value = shop.holidays || '';
                            document.getElementById('map_url').value = shop.map_url || '';
                            document.getElementById('company_email').value = shop.company_email || '';
                        }
                    }
                })
                .catch(error => console.error('Error loading shop data:', error));
            }

            function clearForm() {
                document.getElementById('name').value = '';
                document.getElementById('address').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('nearest_station').value = '';
                document.getElementById('business_hours').value = '';
                document.getElementById('holidays').value = '';
                document.getElementById('map_url').value = '';
                document.getElementById('company_email').value = '';
            }
        });
        </script>
    </div>
    <?php
}
?>