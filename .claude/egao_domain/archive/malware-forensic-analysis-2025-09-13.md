# マルウェア感染フォレンジック分析レポート
**日付**: 2025年9月13日
**対象サーバー**: sv504.xbiz.ne.jp (egao-salon)
**分析実行者**: Claude Code Security Analysis

## 概要
egao-salonサーバー（sv504.xbiz.ne.jp）に対する大規模マルウェア感染攻撃の詳細分析。複数ドメインにわたる23+個の悪性PHPファイルが展開され、WordPressコアファイルの改ざんが実行された。

## 攻撃タイムライン

### 段階1: 初期感染活動
- **01:39:33** - 最初の感染活動開始（WordPressログより）
- **14:21:04** - プラグイン改ざん活動（Duplicate Postプラグイン）

### 段階2: 大規模展開フェーズ
- **16:51:52** - **メイン攻撃実行時刻**
  - 23+個の悪性PHPファイルが同時作成
  - 複数ドメインに同時展開：
    - egao-salon.jp
    - 678photo.com
    - sugamo-navi.com
    - careerpath-finder.com
    - san-developer.com

### 段階3: ペイロード配置
- **16:52:00** - wp-content/uploads/wp/ディレクトリに170KBの悪性ファイル配置
  - `MMxzerVr.php` (170KB) - メインペイロード

## 発見されたマルウェアパターン

### 1. wp-confiq.php系統
**ファイル名**: `wp-confiq.php` (正規のwp-config.phpの名前を模倣)
**場所**: 複数ドメインのpublic_htmlディレクトリ直下
**特徴**:
- 設定ファイルを装った悪性コード
- WordPressの設定情報を盗取する可能性

### 2. base64エンコード系統
**主要ファイル**: `/wp-includes/revisions.php`
**特徴**:
```php
<?php ini_set('memory_limit','-1');$a="ba";$b="xjcWQ7IGZVS2";$c="s";$d="xjcWQ7IGZVS2";
```
- メモリ制限解除
- base64_decode + eval による動的実行
- 大容量ペイロード（通常数KB〜数十KB）

### 3. WordPress Core改ざん
**影響を受けたファイル**:
- `index.php`
- `header.php`
- `wp-blog-header.php`（削除された）

**改ざんパターン**:
```php
eval($o($p)); // 動的コード実行
```

## 攻撃ベクター分析

### 主要侵入経路: ファイルアップロード脆弱性
1. **wp-content/uploads/** ディレクトリへの不正アップロード
2. **16:52**時点でのwpディレクトリ作成
3. 170KBの大型ペイロード配置（`MMxzerVr.php`）

### 展開方法
1. 初回ペイロードアップロード
2. 権限昇格・拡散スクリプト実行
3. 複数ドメインへの同時感染
4. WordPressコアファイルの体系的改ざん

## セキュリティ影響度評価

### 重大度: **Critical**
- **影響範囲**: 5つのドメイン全体
- **データ完全性**: 重大な損失
- **復旧複雑度**: 高
- **継続的脅威**: あり（バックドア可能性）

### 主な脅威
1. **データ流出リスク**
   - データベース情報
   - ユーザー認証情報
   - サイト設定情報

2. **サイト可用性影響**
   - WordPressサイトの動作不良
   - Fatal errorによるサービス停止
   - SEOへの悪影響

3. **二次感染リスク**
   - 訪問者への悪性コード配布
   - マルウェア配信サイトとして利用

## 実行された対策

### 即座対応（完了済み）
1. ✅ 悪性ファイルの特定・無効化（23+ファイル）
2. ✅ WordPressコアファイルの復旧
3. ✅ wp-confiq.phpファイルの削除
4. ✅ 大型ペイロードファイルの無効化

### 継続監視項目
1. 🔄 プロセス監視（実行中の不審なPHPプロセス）
2. 🔄 ファイル整合性チェック
3. 🔄 アクセスログ監視

## 推奨される追加対策

### 短期対策（緊急）
1. **全WordPressサイトのパスワード変更**
   - 管理者パスワード
   - データベースパスワード
   - FTP/SSH認証情報

2. **WordPress・プラグイン・テーマの更新**
   - WordPress コア最新版適用
   - 全プラグインのセキュリティ更新
   - テーマファイルの検証

3. **ファイルアップロード制限強化**
   - .php, .js 等実行可能ファイルのアップロード禁止
   - uploads ディレクトリの実行権限剥奪
   - ファイルタイプ検証の実装

### 中長期対策
1. **WAF（Web Application Firewall）導入**
2. **定期的なマルウェアスキャン自動化**
3. **ファイル改ざん検知システム**
4. **セキュリティプラグイン導入**（Wordfence、Sucuri等）

## 技術的詳細

### 攻撃者の技術レベル
- **中〜高レベル**の攻撃者による組織的攻撃
- 複数ドメイン同時攻撃の自動化
- WordPressの構造を熟知した攻撃手法
- ステルス性を考慮したファイル命名

### 使用された回避技術
1. **ファイル名偽装**: wp-confiq.php（正規ファイル名の類似）
2. **base64エンコード**: ペイロードの難読化
3. **分散配置**: 単一ファイルではなく複数ファイルに分散
4. **コアファイル改ざん**: 検知困難な場所への埋め込み

## 結論

本インシデントは**高度で組織的な攻撃**であり、攻撃者はWordPressの脆弱性を悪用したファイルアップロード攻撃を実行し、短時間で複数ドメインに悪性コードを展開した。

**主な学習点**:
1. ファイルアップロード機能のセキュリティ不備が主要な侵入経路
2. 16:51:52の約1分間で大規模な感染が完了
3. WordPressの体系的知識を持つ攻撃者による計画的攻撃

**今後の重点対策**:
- ファイルアップロード機能の全面的セキュリティ見直し
- リアルタイムファイル監視システムの導入
- WordPressセキュリティのベストプラクティス適用

---
**緊急度**: Critical
**次回検証推奨**: 24時間以内
**最終更新**: 2025-09-13 22:30 JST